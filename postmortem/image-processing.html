<!doctype html><html lang="en"><head><title data-preact-helmet>Vernissage! - Image Processing</title><meta data-preact-helmet charset="UTF-8"><meta data-preact-helmet name="description" content="Post-mortem about platane&#x27;s 13kjs game entry: Vernissage"><meta data-preact-helmet name="twitter:creator" content="platane_"><meta data-preact-helmet name="twitter:url" content="https://platane.github.io/js13k-2017/postmortem/image-processing"><meta data-preact-helmet name="twitter:card" content="summary"><meta data-preact-helmet name="twitter:title" content="Vernissage! - Image Processing"><meta data-preact-helmet name="twitter:description" content="Post-mortem about platane&#x27;s 13kjs game entry: Vernissage"><meta data-preact-helmet name="twitter:image" content="https://platane.github.io/js13k-2017/postmortem/7df0379c.jpg"><meta data-preact-helmet property="og:description" content="Post-mortem about platane&#x27;s 13kjs game entry: Vernissage"><meta data-preact-helmet property="og:type" content="article"><meta data-preact-helmet property="og:url" content="https://platane.github.io/js13k-2017/postmortem/image-processing"><meta data-preact-helmet property="og:image" content="https://platane.github.io/js13k-2017/postmortem/1c41a378.jpg"><link data-preact-helmet rel="canonical" href="https://platane.github.io/js13k-2017/postmortem/image-processing"><style>*,*::before,*::after{box-sizing:border-box;}body{position:relative;margin:0;}.css-1yfs2uq{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:#fff;}.css-1jke4yk{position:relative;width:100%;}.css-7b7t20{color:#000;}.css-18g04z2{margin-top:30%;width:100%;min-height:200px;max-height:400px;}.css-1526ib8{position:absolute;top:0;left:0;right:0;bottom:0;}.css-t0t1p7{display:block;width:100%;height:100%;position:absolute;top:0;left:0;right:0;bottom:0;object-fit:cover;object-position:center;}.css-374rh2{position:absolute;top:0;left:0;right:0;bottom:0;background-image:linear-gradient( 0deg,rgba(0,0,0,0.6) 30%,rgba(0,0,0,0.2) 60%,rgba(0,0,0,0) 80% );}.css-1wzpj8r{position:absolute;top:0;left:0;right:0;bottom:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-146xtwn{margin-top:20%;color:#fff;font-family:helvetica,sans-serif;font-weight:bold;font-size:60px;-webkit-letter-spacing:3px;-moz-letter-spacing:3px;-ms-letter-spacing:3px;letter-spacing:3px;text-shadow:0 0 3px rgba(0,0,0,0.5);}.css-gtqo25{margin-top:10px;color:#fff;font-family:helvetica,sans-serif;font-size:30px;-webkit-letter-spacing:2px;-moz-letter-spacing:2px;-ms-letter-spacing:2px;letter-spacing:2px;text-shadow:0 0 3px rgba(0,0,0,0.5);text-align:center;}.css-1vxz0if{margin-left:auto;margin-right:auto;max-width:1000px;width:100%;padding:40px;}.css-5prk2d{font-family:helvetica,sans-serif;font-size:60px;-webkit-letter-spacing:2px;-moz-letter-spacing:2px;-ms-letter-spacing:2px;letter-spacing:2px;font-weight:bold;}.css-1wf5ba{margin:12px 0;}.css-37xzak{font-family:Georgia,Cambria,'Times New Roman',Times,serif;font-size:18px;line-height:1.3em;margin:0;}.css-1u6wcxr{margin:0;margin-top:50px;}.css-1u6wcxr span{font-family:'Lucida Grande','Lucida Sans Unicode','Lucida Sans',Geneva,Arial,sans-serif;font-size:40px;font-weight:bold;}.css-135q21e > *{display:list-item;margin:8px 0;}.css-1qpajkh{width:100%;position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-1sl9luj{width:20px;height:20px;margin-left:10px;margin-right:10px;}.css-1vd84sn{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-noyp4u{margin:0;margin-top:40px;}.css-noyp4u span{font-family:'Lucida Grande','Lucida Sans Unicode','Lucida Sans',Geneva,Arial,sans-serif;font-size:28px;font-weight:bold;}.css-1neoknu{padding:10px 0;margin:12px 0;background-color:#eee;}.css-w7duh2{position:relative;padding:50px 20px;max-width:1000px;width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-teffdf{margin:12px 0;padding:1px 0;margin-left:12px;padding-left:10px;border-left:solid 2px #888;background-color:#eee;}.css-1msjh1x{font-style:italic;}</style></head><body><div class="css-0 css-1h7sbek0"><div class="css-1yfs2uq css-1h7sbek1"><div class="css-1jke4yk css-jbwiz30"><a href="/js13k-2017/postmortem//" class="css-7b7t20 css-xz5p2t0"><div class="css-18g04z2 css-jbwiz35"></div><div class="css-1526ib8 css-jbwiz36"><img src="/js13k-2017/postmortem/d52a095a.jpg" alt="article header" class="css-t0t1p7 css-jbwiz37" /></div><div class="css-374rh2 css-jbwiz31"></div><div class="css-1wzpj8r css-jbwiz32"><span class="css-146xtwn css-jbwiz33">Vernissage!</span><span class="css-gtqo25 css-jbwiz34">js13k game post-mortem</span></div></a></div><div class="css-1vxz0if css-1h7sbek2"><div class="css-0 css-qtfxc010"><h1 class="css-5prk2d css-qtfxc09">Image Processing</h1><div><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">This part described how I manage to crush images into a handful of bit, and still have something recognizable.</span></p><h2 id="inspiration" class="css-1u6wcxr css-qtfxc00"><span class="css-37xzak css-qtfxc01">Inspiration</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">I had in mind a demo I saw some times ago:</span></p><p class="css-1wf5ba css-qtfxc04"><a href="https://rogerjohansson.blog/2008/12/07/genetic-programming-evolution-of-mona-lisa/" class="css-7b7t20 css-xz5p2t0"><span href="https://rogerjohansson.blog/2008/12/07/genetic-programming-evolution-of-mona-lisa/" class="css-37xzak css-qtfxc01">Evolution of Mona Lisa by Roger Johansson</span></a></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">It uses polygons to approximate the image. I wanted to use disk instead for aesthetic reasons. At the price of a less precise approximation.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Such algorithm already exists : </span><a href="https://www.youtube.com/watch?v=rGt3iMAJVT8" class="css-7b7t20 css-xz5p2t0"><span href="https://www.youtube.com/watch?v=rGt3iMAJVT8" class="css-37xzak css-qtfxc01">Mona Lisa approximated with 150 circles</span></a><span class="css-37xzak css-qtfxc01">. Although is this case, the </span><a href="https://github.com/handcraftsman" class="css-7b7t20 css-xz5p2t0"><span href="https://github.com/handcraftsman" class="css-37xzak css-qtfxc01">author</span></a><span class="css-37xzak css-qtfxc01"> did not provide much implementation details.</span></p><h2 id="algorithm" class="css-1u6wcxr css-qtfxc00"><span class="css-37xzak css-qtfxc01">Algorithm</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">The algorithm I used yield good results:</span><div></div></p><div class="css-1vd84sn css-qtfxc05"><img style="max-height: 400px; max-width: 90%; flex-shrink: 1; margin: 10px;" alt="input" src="/js13k-2017/postmortem/68842605.png" class="css-0 css-1lspumq0" /><img style="max-height: 400px; max-width: 90%; flex-shrink: 1; margin: 10px;" alt="output" src="/js13k-2017/postmortem/7df0379c.jpg" class="css-0 css-1lspumq0" /></div><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Which looks way better if you take a step back:</span><div></div></p><div class="css-1vd84sn css-qtfxc05"><img style="max-height: 400px; max-width: 90%; flex-shrink: 1; margin: 10px;" alt="input" src="/js13k-2017/postmortem/f5cb37b4.png" class="css-0 css-1lspumq0" /><img style="max-height: 400px; max-width: 90%; flex-shrink: 1; margin: 10px;" alt="output" src="/js13k-2017/postmortem/dfd41499.jpg" class="css-0 css-1lspumq0" /></div><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Let's take a look inside and figure out how it is working.</span></p><h2 id="genetic-algorithm-you-said?" class="css-noyp4u css-qtfxc00"><span class="css-37xzak css-qtfxc01">Genetic Algorithm you said?</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Genetic programming is quite amazing. It's fun to explain because it relies on knowledge that everybody learn in hight school.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">It's based on Darwin's evolution theory: Starting for a population of solution, let's mutate a little the solution at each generation and keep the best ones.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">In order to use it we must:</span></p><ul class="css-135q21e css-qtfxc08"><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Have a way to determine if a solution is better than another.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Describe the &quot;gene&quot; of a solution, a structure of data of quantified which can be altered.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Explicit how the solution gene mutate, to result in a slightly different solution.</span></p></ul><h2 id="data-structure" class="css-noyp4u css-qtfxc00"><span class="css-37xzak css-qtfxc01">data structure</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">To begin, we must define what is the &quot;gene&quot; of a solution: How do we describe the solution.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">For our case, the gene will be an array of disks, each of theses disks have</span></p><ul class="css-135q21e css-qtfxc08"><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">a position</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">a radius</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">a color</span></p></ul><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Given a certain solution expressed with this data structure, we can draw the image solution.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">And from there, we can compute the &quot;fitness&quot; which describe how good the solution is.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">In our case, the fitness will be derived from the difference between the target image and the image solution.</span></p><h2 id="implementation" class="css-1u6wcxr css-qtfxc00"><span class="css-37xzak css-qtfxc01">Implementation</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">We have the big picture, now we let's dive into the implementation details.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Let's lay the rules:</span></p><h2 id="1.-how-the-fitness-is-computed" class="css-noyp4u css-qtfxc00"><span class="css-37xzak css-qtfxc01">1. How the fitness is computed</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Here I compute the color distance for each pixel of the image. And sum the errors.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">The distance is a simple euclidian distance in the rbg space.</span></p><div class="css-teffdf css-qtfxc07"><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">We may argue that using a distance which respect the eye spec will be more relevant. ( the human eye tends to discern easily distance between bright colors than dark ones, or something like that )</span><div></div><span class="css-37xzak css-qtfxc01">I actually tried and did not had pertinent results with hsl space.</span></p></div><h2 id="2.-how-the-gene-mutate" class="css-noyp4u css-qtfxc00"><span class="css-37xzak css-qtfxc01">2. How the gene mutate</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Is the mutated gene close to the original ( soft mutation ), or is quite different ( hard mutation ) ?</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">This is a hard question, too close to the original and you may fall into local maximum, too far and you may never converge.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">One technique derived from &quot;simulated annealing&quot; is to make hard mutation at start to explore the solution space, and as the generation goes, soften them to refine.</span></p><div class="css-1vd84sn css-qtfxc05"><img style="max-height: 400px; max-width: 90%; flex-shrink: 1; margin: 10px;" alt="wikipedia illustration of simulated annealing" src="https://upload.wikimedia.org/wikipedia/commons/d/d5/Hill_Climbing_with_Simulated_Annealing.gif" class="css-0 css-1lspumq0" /></div><p class="css-1wf5ba css-qtfxc04"><span class="css-1msjh1x css-qtfxc03"><span class="css-37xzak css-qtfxc01">This illustration from wikipedia shows how simulated annealing avoid improving a local maximum. </span><a href="https://en.wikipedia.org/wiki/Simulated_annealing" class="css-7b7t20 css-xz5p2t0"><span href="https://en.wikipedia.org/wiki/Simulated_annealing" class="css-37xzak css-qtfxc01">wikipedia simulated annealing </span></a></span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">This is the solution implemented: after X mutation which does not improve the solution, use soft mutation instead.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">The hard mutation either:</span></p><ul class="css-135q21e css-qtfxc08"><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">swap a disk with another one</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">random a disk ( set a random color, position and radius )</span></p></ul><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">And the soft one either:</span></p><ul class="css-135q21e css-qtfxc08"><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">move the location to a close position</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">set the color, to a close one</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">alter the radius</span></p></ul><h2 id="3.-how-two-genes-are-combined" class="css-noyp4u css-qtfxc00"><span class="css-37xzak css-qtfxc01">3. How two genes are combined</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">In a classic genetic algorithm, one way to generate a solution at the N+1 generation is to take two solutions from the N generation and combined them together. However it did not makes much sense in our case and I decide to discard this mechanism.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">As such, the only way to generate a new solution is by mutation.</span></p><h2 id="4.-how-the-gene-pool-is-groomed" class="css-noyp4u css-qtfxc00"><span class="css-37xzak css-qtfxc01">4. How the gene pool is groomed</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Should we keep only the better solutions ? How many &quot;bad&quot; solution should we keep ?</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Once again this question is about &quot;exploring the space vs refining a solution&quot;, with the danger of falling into local maximum or converge slowly.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">In our case, the state of the art I found tends to keep only one solution in the gene pool.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">I tries myself to use a larger genetic pool, without success.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">I implemented a solution with a single element in the gene pool. At each generation, the mutation is either better and used, or worst and discarded. This simplify greatly the algorithm, although it's not really a genetic algorithm anymore, but something more like hill climbing algorithm.</span></p><div class="css-teffdf css-qtfxc07"><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Maybe I should have not give up on the genetic aspect this fast.</span></p></div><h2 id="5.-incremental-solution" class="css-noyp4u css-qtfxc00"><span class="css-37xzak css-qtfxc01">5. Incremental solution</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Some algorithm I have found use a clever trick. They start with 8 disks, converge to a best solution, then add 8 another disk then converge, ect ...</span></p><div class="css-1vd84sn css-qtfxc05"><img style="max-height: 400px; max-width: 90%; flex-shrink: 1; margin: 10px;" alt="incremental solutions" src="/js13k-2017/postmortem/dd58fc23.png" class="css-0 css-1lspumq0" /></div><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">I had better results with this methods. And I got a way to monitor the progress.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Better, I used it to parallelize the algorithm :</span></p><ul class="css-135q21e css-qtfxc08"><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">starting from a blank solution, converge to a good solution with 8 disks</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">repeat to have N solution with 8 disks</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">take the best solution with 8 disk, to work a solution with 16 disk</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">repeat to have N solution with 16 disks</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">...</span></p></ul><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">See ? now process can work isolated on making a solution converge. Sharing the result in a common solution tree.</span></p><div class="css-1vd84sn css-qtfxc05"><img style="max-height: 400px; max-width: 90%; flex-shrink: 1; margin: 10px;" alt="solution tree" src="/js13k-2017/postmortem/cdd2be8f.jpg" class="css-0 css-1lspumq0" /></div><h2 id="cloudify" class="css-1u6wcxr css-qtfxc00"><span class="css-37xzak css-qtfxc01">Cloudify</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">We have a solution which allows parallelization, let's spend some money on a big machine !</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">I use a redis cache to store the common solution, and spawn several machine in google compute engine to do the job.</span></p><div class="css-teffdf css-qtfxc07"><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">while lamba calculus solutions ( aws lambda, gcp Function ... ) seems to fit here, they are not. The computation take some minutes, and will likely hit the timeout before end.</span></p></div><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">The flow is :</span></p><ul class="css-135q21e css-qtfxc08"><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">A process is launched</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">It get the solution tree, find a task to do ( take a N solution, make the N+8 solution converge )</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">make the solution converge</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">write the solution</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">repeat</span></p></ul><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">And why not a front to read the solution tree and display the progress ?</span></p><div class="css-1vd84sn css-qtfxc05"><img style="max-height: 400px; max-width: 90%; flex-shrink: 1; margin: 10px;" alt="The dashboard" src="/js13k-2017/postmortem/f62dc3c8.jpg" class="css-0 css-1lspumq0" /></div><p class="css-1wf5ba css-qtfxc04"><span class="css-1msjh1x css-qtfxc03"><a href="https://platane.github.io/js13k-2017/image-crusher-ui" class="css-7b7t20 css-xz5p2t0"><span href="https://platane.github.io/js13k-2017/image-crusher-ui" class="css-37xzak css-qtfxc01">visit the dashboard</span></a></span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">As you can see, we have several solutions as the tree leafs. I like to human pick the final solution, rather than take the one with the best fitness. To catch that little bit that the machine can't extract if you allows me to say.</span></p><h2 id="encoding" class="css-1u6wcxr css-qtfxc00"><span class="css-37xzak css-qtfxc01">Encoding</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">We are not done yet!</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Remember the goal is to reduce the size of the asset to the minimum. Using JSON file is certainly not an option.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">First, one thing I did not tell you is that the disk parameters are quantified:</span></p><ul class="css-135q21e css-qtfxc08"><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">the position is on a 64x64 grid</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">the color is contained in a palette of 256 elements</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">the color opacity is picked between 4 values</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">the radius is picket between 16 elements</span></p></ul><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">So one disk can be encoded as bit array :</span></p><pre class="css-1neoknu css-qtfxc06"> #### #### #### | #### #### | #### | ##

    position        color    radius  opacity
</pre><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Which can be concatenated to represent the whole disk array.</span></p><h2 id="binary-data-in-js" class="css-noyp4u css-qtfxc00"><span class="css-37xzak css-qtfxc01">Binary data in Js</span></h2><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">Manipulating binary data is not so trivial in Js.</span></p><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">To do so, I write the binary as a file. It's possible with Uint8Array. With some tricks, I made the file downloadable from the app.</span></p><div class="css-1vd84sn css-qtfxc05"><img style="max-height: 400px; max-width: 90%; flex-shrink: 1; margin: 10px;" alt="download adn file" src="/js13k-2017/postmortem/6b057325.gif" class="css-0 css-1lspumq0" /></div><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">To read it, I use</span></p><pre class="css-1neoknu css-qtfxc06">fetch(fileUrl).then(res =&gt; res.arrayBuffer())
</pre><p class="css-1wf5ba css-qtfxc04"><span class="css-37xzak css-qtfxc01">then it's a simple parsing to retrieve the original data.</span></p></div></div></div><div class="css-w7duh2 css-1fviwn70"><a href="/js13k-2017/postmortem//" class="css-7b7t20 css-xz5p2t0">summary</a><a href="/js13k-2017/postmortem/graphics" class="css-7b7t20 css-xz5p2t0">graphics -&gt;</a></div><div class="css-1qpajkh css-1gtjn9g1"><div>made by <a href="https://twitter.com/platane_">@platane</a></div><a href="https://github.com/platane/js13k-2017"><svg viewBox="0 0 438.549 438.549" class="css-1sl9luj css-1gtjn9g0"><path d="M409.132,114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736,15.166,259.057,5.365,219.271,5.365c-39.781,0-76.472,9.804-110.063,29.408c-33.596,19.605-60.192,46.204-79.8,79.8C9.803,148.168,0,184.854,0,224.63c0,47.78,13.94,90.745,41.827,128.906c27.884,38.164,63.906,64.572,108.063,79.227c5.14,0.954,8.945,0.283,11.419-1.996c2.475-2.282,3.711-5.14,3.711-8.562c0-0.571-0.049-5.708-0.144-15.417c-0.098-9.709-0.144-18.179-0.144-25.406l-6.567,1.136c-4.187,0.767-9.469,1.092-15.846,1c-6.374-0.089-12.991-0.757-19.842-1.999c-6.854-1.231-13.229-4.086-19.13-8.559c-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559c-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-0.951-2.568-2.098-3.711-3.429c-1.142-1.331-1.997-2.663-2.568-3.997c-0.572-1.335-0.098-2.43,1.427-3.289c1.525-0.859,4.281-1.276,8.28-1.276l5.708,0.853c3.807,0.763,8.516,3.042,14.133,6.851c5.614,3.806,10.229,8.754,13.846,14.842c4.38,7.806,9.657,13.754,15.846,17.847c6.184,4.093,12.419,6.136,18.699,6.136c6.28,0,11.704-0.476,16.274-1.423c4.565-0.952,8.848-2.383,12.847-4.285c1.713-12.758,6.377-22.559,13.988-29.41c-10.848-1.14-20.601-2.857-29.264-5.14c-8.658-2.286-17.605-5.996-26.835-11.14c-9.235-5.137-16.896-11.516-22.985-19.126c-6.09-7.614-11.088-17.61-14.987-29.979c-3.901-12.374-5.852-26.648-5.852-42.826c0-23.035,7.52-42.637,22.557-58.817c-7.044-17.318-6.379-36.732,1.997-58.24c5.52-1.715,13.706-0.428,24.554,3.853c10.85,4.283,18.794,7.952,23.84,10.994c5.046,3.041,9.089,5.618,12.135,7.708c17.705-4.947,35.976-7.421,54.818-7.421s37.117,2.474,54.823,7.421l10.849-6.849c7.419-4.57,16.18-8.758,26.262-12.565c10.088-3.805,17.802-4.853,23.134-3.138c8.562,21.509,9.325,40.922,2.279,58.24c15.036,16.18,22.559,35.787,22.559,58.817c0,16.178-1.958,30.497-5.853,42.966c-3.9,12.471-8.941,22.457-15.125,29.979c-6.191,7.521-13.901,13.85-23.131,18.986c-9.232,5.14-18.182,8.85-26.84,11.136c-8.662,2.286-18.415,4.004-29.263,5.146c9.894,8.562,14.842,22.077,14.842,40.539v60.237c0,3.422,1.19,6.279,3.572,8.562c2.379,2.279,6.136,2.95,11.276,1.995c44.163-14.653,80.185-41.062,108.068-79.226c27.88-38.161,41.825-81.126,41.825-128.906C438.536,184.851,428.728,148.168,409.132,114.573z"></path></svg></a></div></div></div></body><script src="/js13k-2017/postmortem/c33ebd69.js"></script><script>window.__emotion_ids=['0','1fuveuj','1yfs2uq','1jke4yk','7b7t20','18g04z2','1526ib8','t0t1p7','374rh2','1wzpj8r','146xtwn','gtqo25','1vxz0if','5prk2d','1wf5ba','37xzak','1u6wcxr','135q21e','1qpajkh','1sl9luj','1vd84sn','noyp4u','1neoknu','w7duh2','teffdf','1msjh1x']</script></html>