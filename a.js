const a=64,b=[.2,.5,.8,1],c=[2,3,4,5,6,7,8,10,12,14,16,18,22,26,30,40],d=[];for(let b=0;256>b;b+=50)for(let a=0;256>a;a+=50)for(let c=0;256>c;c+=42)d.push([b,a,c]);const e=[{x:0,y:1},{x:1,y:0},{x:0,y:-1},{x:-1,y:0},{x:1,y:1},{x:-1,y:1},{x:-1,y:-1},{x:1,y:-1}],f=new THREE.MeshPhongMaterial({color:16316664}),g=new THREE.MeshPhongMaterial({color:13158600}),i=new THREE.MeshBasicMaterial({color:11184810}),j=.28,h=100,k=new THREE.PlaneBufferGeometry(1,1),m=(d,a,b)=>Math.max(0,Math.min(1,(b-(1-j)*(d-a)/d)/j)),n=(i,a,b,d)=>{const e=(36*i+137*(a*a*i)+89*(i*i))%37/37,f=Math.sin(.045*(1+e)*d)*b,g=Math.cos(.035*(1+e)*d)*b,h=i-.5+(.5>i?-.4:.4);return{x:i+h*b+.2*f,y:a+(a-.5)*b+.17*g,z:b*(.6+.6*e+.23*f*(1+e)),s:.3+.7*(1-b)}},o=(i,o,b,a,c,e)=>{const f=512;i.width=i.height=512;const g=i.getContext('2d');g.beginPath(),g.rect(0,0,512,512),g.fillStyle='#fff',g.fill(),b.forEach((h,a)=>{const j=m(b.length,a,c),i=n(h.x/o,h.y/o,j,e),k=h.r*i.s/o,d=i.z>k?0:Math.sqrt(k*k-i.z*i.z);g.beginPath(),g.arc(i.x*f,i.y*f,d*f,0,2*Math.PI),g.fillStyle='rgb('+h.color+')',g.globalAlpha=h.opacity,g.fill()}),.8<c&&a&&(g.globalAlpha=(c-.8)/.2,a.forEach((c,a)=>{g.fillStyle='#333',g.font='50px Helvetica',g.fillText(c,50,60*a+100)}))},q=(r,a,b)=>{var c=Math.ceil,s=Math.PI,t=Math.min;const u=64,e=new THREE.Object3D,f=document.createElement('canvas'),v=f.getContext('2d');v.fillStyle='#fff',v.fillRect(0,0,64,64),r.forEach(({r:m,opacity:a,color:b,x:g,y:h})=>{const d=new THREE.MeshLambertMaterial;{v.beginPath(),v.arc(g,h,m,0,2*s),v.fillStyle='rgb('+b+')',v.globalAlpha=a,v.fill();const{data:e}=v.getImageData(0,0,u,u),f=[0,0,0];let i=0;for(let c=-m;c<m;c++)for(let b=-m;b<m;b++)if(c*c+b*b<m*m&&0<=g+c&&0<=h+b&&g+c<u&&h+b<u){const d=4*(1*(g+c)+(h+b)*u);f[0]+=e[d+0],f[1]+=e[d+1],f[2]+=e[d+2],i++}d.color.setRGB(f[0]/i/255,f[1]/i/255,f[2]/i/255)}const f=new THREE.SphereBufferGeometry(t(m/u,.5),c(m/4)+4,c(m/4)+4),i=new THREE.Mesh(f,d);e.add(i)});const d=new THREE.Texture(f);{d.needsUpdate=!0,d.wrapS=d.wrapT=THREE.RepeatWrapping,d.repeat.set(1,1);const f=new THREE.MeshBasicMaterial;f.map=d;const a=new THREE.Mesh(k,f);a.position.z=.02,e.add(a);const b=new THREE.Mesh(k,g);b.position.z=.01,b.scale.set(1.1,1.1,1.1),e.add(b)}let h=-1;const i=(j,k)=>{var c=Math.abs;a>E&&(j=0),a==E&&.9<j&&E<G.step_max-1&&E++,(0<j||.1<c(j-h)||0<h&&0==j)&&(o(f,u,r,b,h=j,k),d.needsUpdate=!0,r.forEach((a,b)=>{const c=m(r.length,b,j),d=n(a.x/u,a.y/u,c,k);e.children[b].visible=0<c,e.children[b].scale.set(d.s,d.s,d.s*c),e.children[b].position.set(d.x-.5,-(d.y-.5),d.z-.1)}))};return i(0,0),{object:e,update:i,t:0}},r=(a,b)=>{var c=Math.PI,k=Math.max,l=Math.min;const n=[],d=new THREE.Object3D,f=()=>{const g=a.shift(),h=b.shift();if(g){const b=q(g.adn,n.length,h||[]);n.push(b);const i=e[g.k],j=(19*(g.y*g.x)+37*g.x+g.y*g.y+7*i.y+23*i.x)%27/27,a=.6+.35*j;b.object.scale.set(a,a,a),b.object.position.set(g.x+.5+.51*i.x,1,g.y+.5+.51*i.y),b.object.rotation.y=c/2*g.k,d.add(b.object),requestAnimationFrame(f)}};f();let m=0;return{object:d,update:({position:e,direction:a})=>{m+=1,n.forEach(b=>{const c=e.x-b.object.position.x,f=e.y-b.object.position.z,g=Math.sqrt(c*c+f*f),i=k(0,-(c*a.x+f*a.y)/g);b.t=3>g&&.92<i?l(150,b.t+1):k(.98*(b.t+1)-2,0),b.update(k(0,(b.t-50)/h),m)})}}},t=new THREE.MeshLambertMaterial;{const d=document.createElement('canvas');d.width=512,d.height=1;const e=d.getContext('2d');for(let b=16;b--;){e.beginPath(),e.rect(32*b,0,32,1);const a=32+(0|8*Math.random()),c=22+(0|20*Math.random());e.fillStyle=`hsl(${a}, 55%, ${c}%)`,e.fill()}const a=new THREE.Texture(d,THREE.UVMapping,THREE.RepeatWrapping,THREE.LinearFilter,THREE.LinearFilter);a.needsUpdate=!0,a.repeat.set(10,1),t.map=a}const u=r=>{var g=Math.PI,h=Math.sqrt,j=Math.max,k=Math.min;const n=new THREE.Object3D,b=r.length,l=r[0].length,o=new THREE.MeshLambertMaterial;{const b=document.createElement('canvas');b.height=1,b.width=256;const e=b.getContext('2d');for(let b=256;b--;)e.fillStyle=.06<b/256?'#fff':'#888',e.fillRect(b,0,1,1);const a=new THREE.Texture(b,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.LinearFilter,THREE.LinearFilter);a.needsUpdate=!0,o.map=a}{const b=document.createElement('canvas');b.width=b.height=64;const i=b.getContext('2d');i.fillStyle='#fff',i.fillRect(0,0,64,64);for(let b=64;b--;)for(let a=64;a--;){const c=h(b*b+a*a)/h(4096)/1.45,d=k(1,j(0,3*(1-a/64))),e=k(1,j(0,3*(a/64)));i.fillStyle=`hsl(0, 0%, ${100*((.4+.6*(1-(1-d)*(1-d)))*(1-c*c)*(.88+.12*e))}%)`,i.fillRect(b,a,1,1)}const a=new THREE.Texture(b,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.NearestFilter,THREE.LinearFilter);a.needsUpdate=!0,o.aoMap=a,o.aoMapIntensity=.8}{const a=512,b=document.createElement('canvas');b.width=b.height=512;const i=b.getContext('2d'),d=r.length,e=r[0].length;i.fillStyle='#fff',i.fillRect(0,0,512,512),i.fillStyle='#333',i.filter=`blur(${.12*512/d}px)`;const f=1.12;for(let b=r.length;b--;)for(let c=r[0].length;c--;)r[b][c]&&i.fillRect((b-(f-1)/2)/d*a,(c-(f-1)/2)/e*a,f*a/d,f*a/e);const c=new THREE.Texture(b,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.LinearFilter,THREE.LinearFilter);c.needsUpdate=!0,t.aoMap=c,t.aoMapIntensity=1.4}{const c=new THREE.PlaneGeometry(b,l);c.faceVertexUvs[1]=c.faceVertexUvs[0];const a=new THREE.Mesh(c,t);a.position.set(b/2,0,l/2),a.rotation.x=-g/2,a.receiveShadow=!0,n.add(a)}{const p=new THREE.Geometry;p.faceVertexUvs=[[],[]];const c=new THREE.Vector2(0,0),g=new THREE.Vector2(1,0),h=p.faceVertexUvs[0],i=p.faceVertexUvs[1],s=(j,e,a,b,f)=>{const k=p.faces.length;h[k]=[c,g,g],h[k+1]=[c,g,c],i[k]=[new THREE.Vector2(0,.05),new THREE.Vector2(0,.95),new THREE.Vector2(0,.95)],i[k+1]=[new THREE.Vector2(0,.05),new THREE.Vector2(0,.95),new THREE.Vector2(0,.05)];const d=1-.8*f;b?(i[k][0].x=1,i[k][1].x=1,i[k][2].x=d,i[k+1][0].x=1,i[k+1][1].x=d,i[k+1][2].x=d):a&&(i[k][0].x=d,i[k][1].x=d,i[k][2].x=1,i[k+1][0].x=d,i[k+1][1].x=1,i[k+1][2].x=1),p.faces.push(new THREE.Face3(p.vertices.length+0,p.vertices.length+1,p.vertices.length+2),new THREE.Face3(p.vertices.length+0,p.vertices.length+2,p.vertices.length+3)),p.vertices.push(new THREE.Vector3(e.x,0,e.y),new THREE.Vector3(e.x,1,e.y),new THREE.Vector3(j.x,1,j.y),new THREE.Vector3(j.x,0,j.y))},a=[[],[],[],[]];for(let f=r.length;f--;)for(let b=r[0].length;b--;)if(r[f][b])for(let c=0;4>c;c++)I(r,f+e[c].x,b+e[c].y)||a[c].push({x:f+e[c].x,y:b+e[c].y});for(let k=0;4>k;k++){const c=a[k],g=e[k].y?'y':'x',f='y'===g?'x':'y',d=e[k].y+e[k].x;for(;c.length;){const a=c.shift();let e=a[f],h=e;const i=a[g];for(let a=-1;a!=c.length;){a=c.length;for(let b=c.length;b--;)c[b][g]===i&&(c[b][f]===e-1?(c.splice(b,1),--e):c[b][f]===h+1&&(c.splice(b,1),--h))}const b={},j={};b[g]=j[g]=i+(0==k||1===k?0:1),b[f]=e,j[f]=h+1;const l=h+1-e;let m=!1,d=!1;0===k?(m=I(r,b.x-1,b.y),d=I(r,j.x,j.y)):1===k?(m=I(r,b.x,b.y-1),d=I(r,j.x,j.y)):2===k?(m=I(r,b.x-1,b.y-1),d=I(r,j.x,j.y-1)):3===k&&(m=I(r,b.x-1,b.y-1),d=I(r,j.x-1,j.y));const n=0==k||3===k?s:(e,f,a,b,c)=>s(f,e,b,a,c);if(m&&d){const c={x:(b.x+j.x)/2,y:(b.y+j.y)/2};n(b,c,!0,!1,l/2),n(c,j,!1,!0,l/2)}else n(b,j,m,d,l)}}p.computeFlatVertexNormals(),p.computeFaceNormals(),p.verticesNeedUpdate=!0,p.normalsNeedUpdate=!0,p.uvsNeedUpdate=!0;const b=new THREE.Mesh(p,o);b.scale.set(1,2.8,1),n.add(b)}{const b=new THREE.PlaneBufferGeometry(.08,2*l);for(let c=0;c<r.length;c+=3){const d=new THREE.Mesh(b,i);d.rotation.x=g/2,d.position.set(c+.04,4.5,l/2),n.add(d)}}return n},v=[64,64,c.length,d.length,b.length].map(b=>Math.ceil(Math.log(b)/Math.LN2)),l=v.reduce((c,a)=>c+a,0),p=(f,c,g)=>{let b=0;for(let d=f;d<c;d++){const c=!!(g[Math.floor(d/8)]&1<<d%8);b+=+c<<d-f}return b},s=e=>({x:e[0],y:e[1],r:c[e[2]],color:d[e[3]],opacity:b[e[4]]}),w=e=>{const a=[];for(let f=0;f<=8*e.length-l;)a.push(s(v.map(a=>{const b=f;return f+=a,p(b,f,e)})));return a},z=(i,a)=>Array.from({length:a.length/i}).map((b,c)=>{const[d,e,f]=a.slice(i*c),g=w(a.slice(i*c+3,i*(c+1)));return{x:d,y:e,k:f,adn:g}}),A=(f,a,g)=>{const c=Array.from({length:f}).map(()=>Array.from({length:a}));for(let d=a;d--;)for(let a=f;a--;)c[a][d]=!!p(d*f+a,d*f+a+1,g);return c},B=k=>{const a=new Uint8Array(k),[b,c,d,e,f,g,h]=a,i=Math.ceil(c*b/8);return{grid:A(b,c,a.slice(7,7+i)),paintings:z(d,a.slice(7+i,7+i+d*e)),s:{x:f,y:g,k:h},signs:String.fromCharCode.apply(null,a.slice(7+i+d*e)).split('\0').filter(Boolean).map(b=>b.split('\n'))}},C=location.search.includes('local'),D=(h,a)=>(C?Promise.resolve(localStorage.getItem('museumAsBinary').split(',')):fetch('./map').then(b=>b.arrayBuffer())).then(B).then(({grid:b,paintings:c,signs:d,s:f})=>{var g=Math.PI;if(G.worldGrid=b,G.signs=d,G.paintings=c,G.step_max=G.signs.length,h){G.tim.position.x=f.x+.5,G.tim.position.y=f.y+.5;const a=.5*((f.k-2)*g);G.tim.d={x:e[(f.k+3)%4].x,y:e[(f.k+3)%4].y,a:a},G.tim.camera3d&&(G.tim.camera3d.rotation.y=G.tim.d.a)}a&&(G.tim.position.x=a.x,G.tim.position.y=a.y)});let E=1,F=0;const G={tim:{position:{x:.5,y:1.5},direction:{x:0,y:1}},control:{direction:{x:0,y:0}}},H=(d,a,b)=>0<=a&&a<d.length&&0<=b&&b<d[0].length,I=(d,a,b)=>!H(d,a,b)||!!d[a][b],J=(j,a)=>{var b=Math.floor;const i=b(j.x),c=b(j.y);return e.reduce((d,e)=>{const f=i+e.x,g=c+e.y;if(I(a,f,g)){const a=0===e.x?0:0<e.x?1-j.x%1:j.x%1,b=0===e.y?0:0<e.y?1-j.y%1:j.y%1,c=Math.sqrt(a*a+b*b);return!d||d.d>c?{x:f,y:g,dir:e,d:c}:d}return d},null)},K=()=>{const{position:d,direction:a}=G.tim,b=G.control;d.x+=(a.x*b.direction.y+a.y*b.direction.x)*.05,d.y+=.05*(a.y*b.direction.y-a.x*b.direction.x);const c=J(d,G.worldGrid),e=.2;if(c&&c.d<e){const a=e-c.d;d.x-=a*c.dir.x,d.y-=a*c.dir.y}};AFRAME.registerComponent('tim',{init:function(){{const e=new THREE.BoxGeometry(.1,.1,.1),a=new THREE.MeshLambertMaterial({color:2200494}),b=new THREE.Mesh(e,a);this.el.object3D.add(b);const c=this.el.object3D;G.tim.camera3d=c,G.tim.camera3d.rotation.y=G.tim.d&&G.tim.d.a}},tick:function(){var d=Math.cos,e=Math.sin;if(G.tim.d){const f=this.el.children[0].object3D.rotation.y,a=-e(f),b=-d(f);G.tim.direction.x=a*G.tim.d.x-b*G.tim.d.y,G.tim.direction.y=a*G.tim.d.y+b*G.tim.d.x,K();try{window.opener.updateGamePosition(G.tim)}catch(b){}this.el.object3D.position.set(G.tim.position.x,-1,G.tim.position.y)}}}),AFRAME.registerComponent('museum',{init:function(){const b=this.el.object3D;window.refreshMap=(a,d)=>D(a,d).then(()=>{for(;b.children[0];)b.remove(b.children[0]);b.add(u(G.worldGrid)),this.p=r(G.paintings,G.signs),b.add(this.p.object)}),window.refreshMap(!0)},tick:function(){this.p&&this.p.update(G.tim)}});const L=[0,0,0,0],M=d=>a=>{L[{38:0,32:0,87:0,40:2,83:2,37:1,65:1,39:3,68:3}[a.which]]=d;const b=(L[0]|L[2])&(L[1]|L[3])?Math.SQRT1_2:1;G.control.direction.y=(L[0]-L[2])*b,G.control.direction.x=(L[1]-L[3])*b};document.onkeydown=M(1),document.onkeyup=M(0),document.ontouchstart=()=>G.control.direction.y=1,document.ontouchend=()=>G.control.direction.y=0,window.onload=()=>{const{renderer:b}=document.getElementsByTagName('a-scene')[0];document.getElementById('m').onclick=()=>navigator.getUserMedia({audio:1},d=>{const a=new AudioContext,b=a.createScriptProcessor(4096,1,1);a.createMediaStreamSource(d).connect(b),b.connect(a.destination),b.onaudioprocess=c=>{const a=Math.max(...c.inputBuffer.getChannelData(0));G.control.direction.y=.16<a?1:0}},b=>b)};
